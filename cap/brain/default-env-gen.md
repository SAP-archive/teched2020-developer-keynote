# Generating a default-env.json file

Sometimes you want to run a CAP application locally for testing purposes. If that application requires a connection to a remote service on the Cloud Foundry (CF) runtime of SAP Cloud Platform, you can do this by making service binding details available locally to that application. This is done using values in a specially named file `default-env.json`.

There are various ways to generate the contents needed for such a file, here's one.

The scenario here is where a CAP application running locally must connect to an instance of an SAP Enterprise Messaging service instance running in the CF runtime of an SAP Cloud Platform trial account. The instance name is `emdev`, as described in the [messaging setup document](../../messaging-setup.md).

## Approach

The general idea is that service bindings can be generated by creating a simple, throwaway app in that same CF space, and then binding the service instance to that app.

Following that, we can then use the standard `cf env` command to request the environment variables for that app, which will include the service binding information. Specifically we're looking for the `VCAP_SERVICES` environment variable.

So the approach is to deploy a very simple app, bind the service instance to it, request the environment variables, and then delete the app.

## Following the approach

There are two ways to follow this approach available here - you can do it manually, [step by step](#step-by-step), to understand what's happening. But there's also a small experimental [script](#using-a-script) that will perform all the steps for you, even the editing of the output from `cf env`, thanks to the venerable stream editor [`sed`](https://www.gnu.org/software/sed/manual/sed.html).

### Step by step

First, pick a temporary name for the app - we'll use this throughout these steps. Let's pick `mytempapp` for example.

```sh
$ appname=mytempapp
```

First, make sure that there's no directory called `mytempapp`, and no existing app already deployed with that name:

```sh
$ rmdir $appname
$ cf d -f $appname
```

Now create a new temporary app directory and deploy the app based upon that:

```sh
$ mkdir $appname
$ cf push -c null --no-route --no-start $appname $appname
```

Next, bind the service instance to the app and then request the environment information

```sh
$ cf bind-service $appname emdev
$ cf env $appname > default-env.txt
```

The output of `cf env` contains what we need, but also some extraneous information. So open the `default-env.txt` file up and edit it to leave just the JSON section containing the `VCAP_SERVICES` section, as shown here, i.e. remove everything except what's shown between the START and END cut lines.

```
Getting env variables for app temp in org 4dc50e9btrial / space dev as sapdeveloper@example.com...
OK

System-Provided:
---START----8<------------------------------------------------------------
{
 "VCAP_SERVICES": {
  "enterprise-messaging": [
   {
    "binding_name": null,
    "credentials": {
     "management": [
      {
       "oa2": {
        "clientid": "sb-clone-xbem-service-broker-aec3bfac91f84d61841ef28efb7fa235-clone!b68527|xbem-service-broker-!b2436",
        ...
      }
     ]
    }
    "label": "enterprise-messaging",
    "name": "emdev",
    "plan": "dev",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "enterprise-messaging"
    ],
    "volume_mounts": []
   }
  ]
 }
}
---END------8<------------------------------------------------------------
{
 "VCAP_APPLICATION": {
  "application_id": "d279e412-be5d-48fc-bf40-8d887c77f263",
  "application_name": "temp",
  ...
 }
}

No user-defined env variables have been set

Running Environment Variable Groups:
CREDHUB_API: https://credhub.service.cf.internal

No staging env variables have been set

```

Finally, now you have pure JSON in the file, rename it to `default-env.json` and you're done!

### Using a script

We've written a small script that will perform the steps above. The script is [`default-env-gen`](default-env-gen) and there's also the stream edit commands in [`default-env-gen.sed`](default-env-gen.sed).

The script expects a single mandatory argument - your choice of a name for the temporary app. It will then proceed to run through the above steps, and produce a `default-env.json` file.

Here's an example invocation:

```
$ ./default-env-gen myapp
proxyapp-optimistic-antelope-vv.cfapps.eu10.hana.ondemand.com
Deleting app myapp in org 4dc50e9btrial / space dev as sapdeveloper@example.com...
OK
App myapp does not exist.
Pushing app myapp to org 4dc50e9btrial / space dev as sapdeveloper@example.com...
Getting app info...
Creating app with these attributes...
+ name:       myapp
  path:       /Users/i347491/Projects/teched2020-developer-keynote/cap/brain

Creating app myapp...
Comparing local files to remote cache...
Packaging files to upload...
Uploading files...
 6.24 MiB / 6.24 MiB [===================================================================================] 100.00% 7s

Waiting for API to complete processing files...

name:              myapp
requested state:   stopped
routes:
last uploaded:
stack:
buildpacks:

type:           web
instances:      0/1
memory usage:   1024M
     state   since                  cpu    memory   disk     details
#0   down    2020-12-04T10:20:24Z   0.0%   0 of 0   0 of 0

Binding service emdev to app myapp in org 4dc50e9btrial / space dev as sapdeveloper@example.com...
OK

TIP: Use 'cf restage myapp' to ensure your env variable changes take effect
```

This will have created a fresh `default-env.json` file for you, which will look something like this (some content removed for readability):

```json
{
 "VCAP_SERVICES": {
  "enterprise-messaging": [
   {
    "binding_name": null,
    ...
    "instance_name": "emdev",
    "label": "enterprise-messaging",
    "name": "emdev",
    "plan": "dev",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "enterprise-messaging"
    ],
    "volume_mounts": []
   }
  ]
 }
}
```
